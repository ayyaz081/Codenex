version: '3.8'

services:
  # SQL Server database
  sqlserver:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: codenex-sqlserver
    environment:
      - ACCEPT_EULA=Y
      - SA_PASSWORD=YourStrong!Passw0rd
      - MSSQL_PID=Developer
    ports:
      - "1433:1433"
    volumes:
      - sqlserver_data:/var/opt/mssql
    networks:
      - codenex-network
    healthcheck:
      test: /opt/mssql-tools/bin/sqlcmd -S localhost -U sa -P "YourStrong!Passw0rd" -Q "SELECT 1" || exit 1
      interval: 10s
      timeout: 3s
      retries: 10
      start_period: 10s

  # CodeNex web application
  webapp:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: codenex-webapp
    ports:
      - "7150:7150"
    environment:
      # Database connection
      - DATABASE_CONNECTION_STRING=Server=sqlserver;Database=CodeNexDB;User Id=sa;Password=YourStrong!Passw0rd;TrustServerCertificate=True;
      
      # JWT Configuration (CHANGE IN PRODUCTION!)
      - JWT_KEY=your-super-secret-jwt-key-minimum-32-characters-long-please
      - JWT_ISSUER=CodeNexAPI
      - JWT_AUDIENCE=CodeNexAPI
      - JWT_EXPIRY_HOURS=24
      
      # Email Settings (configure for production)
      - EmailSettings__Host=smtp.gmail.com
      - EmailSettings__Port=587
      - EmailSettings__FromEmail=your-email@example.com
      - EmailSettings__FromName=CodeNex
      - EmailSettings__Username=your-email@example.com
      - EmailSettings__Password=your-app-password
      - EmailSettings__EnableSsl=true
      
      # Admin User (change for production)
      - ADMIN_EMAIL=admin@codenex.com
      - ADMIN_PASSWORD=Admin@123456
      
      # Application settings
      - ASPNETCORE_ENVIRONMENT=Production
      - API_BASE_URL=http://localhost:7150
      - REQUIRE_EMAIL_CONFIRMATION=false
      
      # Optional: GitHub integration
      # - GITHUB_TOKEN=your_github_personal_access_token
      
      # Optional: Stripe payment
      # - Stripe__SecretKey=sk_test_...
      # - Stripe__PublishableKey=pk_test_...
    
    volumes:
      - uploads_data:/app/wwwroot/Uploads
    networks:
      - codenex-network
    depends_on:
      sqlserver:
        condition: service_healthy
    healthcheck:
      test: curl -f http://localhost:7150/health/live || exit 1
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 40s

networks:
  codenex-network:
    driver: bridge

volumes:
  sqlserver_data:
    driver: local
  uploads_data:
    driver: local
