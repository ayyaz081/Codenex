<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Configuration Debug</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .debug-section {
            background: #f5f5f5;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border-left: 4px solid #007acc;
        }
        .debug-section h3 {
            margin-top: 0;
            color: #007acc;
        }
        .code-block {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            margin: 10px 0;
            overflow-x: auto;
        }
        .success {
            color: #22c55e;
        }
        .error {
            color: #ef4444;
        }
        .warning {
            color: #f59e0b;
        }
        button {
            background: #007acc;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        button:hover {
            background: #005a9e;
        }
        #results {
            min-height: 100px;
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 6px;
            background: white;
        }
    </style>
</head>
<body>
    <h1>üîß API Configuration Debug Tool</h1>
    <p>This page helps you verify that your API configuration is working correctly in production.</p>

    <div class="debug-section">
        <h3>üåç Environment Detection</h3>
        <div class="code-block">
            <div>Hostname: <span id="hostname"></span></div>
            <div>Protocol: <span id="protocol"></span></div>
            <div>Port: <span id="port"></span></div>
            <div>Full URL: <span id="fullUrl"></span></div>
        </div>
    </div>

    <div class="debug-section">
        <h3>‚öôÔ∏è Configuration Status</h3>
        <div class="code-block">
            <div>PortfolioConfig Available: <span id="configAvailable"></span></div>
            <div>Environment: <span id="environment"></span></div>
            <div>API Base URL: <span id="apiBaseUrl"></span></div>
            <div>window.API_BASE_URL: <span id="windowApiUrl"></span></div>
        </div>
    </div>

    <div class="debug-section">
        <h3>üß™ API Test</h3>
        <button onclick="testApiHealth()">Test API Health</button>
        <button onclick="testApiSearch()">Test API Search</button>
        <button onclick="clearResults()">Clear Results</button>
        <div id="results"></div>
    </div>

    <div class="debug-section">
        <h3>üìã Troubleshooting Steps</h3>
        <ol>
            <li><strong>Check Environment:</strong> Ensure you're testing on your actual Azure Web App, not localhost</li>
            <li><strong>Check API Base URL:</strong> Should show your Azure Web App URL in production</li>
            <li><strong>Test API Health:</strong> Should return 200 OK from /health endpoint</li>
            <li><strong>Check Browser Console:</strong> Look for any CORS or network errors</li>
            <li><strong>Verify Azure Environment Variables:</strong> Ensure CORS_ALLOWED_ORIGINS and API_BASE_URL are set</li>
        </ol>
    </div>

    <!-- Load the config.js file -->
    <script src="/js/config.js"></script>
    <script>
        // Initialize debug info
        document.addEventListener('DOMContentLoaded', function() {
            updateDebugInfo();
        });

        function updateDebugInfo() {
            // Environment detection
            document.getElementById('hostname').textContent = window.location.hostname;
            document.getElementById('protocol').textContent = window.location.protocol;
            document.getElementById('port').textContent = window.location.port || 'default';
            document.getElementById('fullUrl').textContent = window.location.href;

            // Configuration status
            const configAvailable = typeof PortfolioConfig !== 'undefined';
            document.getElementById('configAvailable').textContent = configAvailable ? '‚úÖ Yes' : '‚ùå No';
            document.getElementById('configAvailable').className = configAvailable ? 'success' : 'error';

            if (configAvailable) {
                document.getElementById('environment').textContent = PortfolioConfig.environment;
                document.getElementById('environment').className = PortfolioConfig.environment === 'production' ? 'success' : 'warning';
                
                const apiUrl = PortfolioConfig.api.getBaseUrl();
                document.getElementById('apiBaseUrl').textContent = apiUrl;
                document.getElementById('apiBaseUrl').className = apiUrl.includes('localhost') ? 'warning' : 'success';
            } else {
                document.getElementById('environment').textContent = 'Config not available';
                document.getElementById('environment').className = 'error';
                document.getElementById('apiBaseUrl').textContent = 'Config not available';
                document.getElementById('apiBaseUrl').className = 'error';
            }

            const windowApiUrl = window.API_BASE_URL || 'Not set';
            document.getElementById('windowApiUrl').textContent = windowApiUrl;
            document.getElementById('windowApiUrl').className = windowApiUrl === 'Not set' ? 'warning' : 'success';
        }

        async function testApiHealth() {
            const results = document.getElementById('results');
            results.innerHTML = '<div>üß™ Testing API Health endpoint...</div>';

            try {
                let apiUrl;
                if (typeof PortfolioConfig !== 'undefined') {
                    apiUrl = PortfolioConfig.api.getBaseUrl() + '/health';
                } else {
                    apiUrl = window.location.origin + '/health';
                }

                const response = await fetch(apiUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                });

                const responseText = await response.text();
                
                results.innerHTML = `
                    <div class="success">‚úÖ API Health Test Results:</div>
                    <div><strong>URL:</strong> ${apiUrl}</div>
                    <div><strong>Status:</strong> ${response.status} ${response.statusText}</div>
                    <div><strong>Response:</strong> ${responseText || 'Empty response'}</div>
                    <div><strong>Headers:</strong> ${JSON.stringify(Object.fromEntries(response.headers.entries()), null, 2)}</div>
                `;
            } catch (error) {
                results.innerHTML = `
                    <div class="error">‚ùå API Health Test Failed:</div>
                    <div><strong>Error:</strong> ${error.message}</div>
                    <div><strong>Check:</strong> CORS configuration, network connectivity, API endpoint availability</div>
                `;
            }
        }

        async function testApiSearch() {
            const results = document.getElementById('results');
            results.innerHTML = '<div>üîç Testing API Search endpoint...</div>';

            try {
                let apiUrl;
                if (typeof PortfolioConfig !== 'undefined') {
                    apiUrl = PortfolioConfig.api.getBaseUrl() + '/api/GlobalSearch?query=test&pageSize=1';
                } else {
                    apiUrl = window.location.origin + '/api/GlobalSearch?query=test&pageSize=1';
                }

                const response = await fetch(apiUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                });

                const responseData = await response.json();
                
                results.innerHTML = `
                    <div class="success">‚úÖ API Search Test Results:</div>
                    <div><strong>URL:</strong> ${apiUrl}</div>
                    <div><strong>Status:</strong> ${response.status} ${response.statusText}</div>
                    <div><strong>Response:</strong> <pre>${JSON.stringify(responseData, null, 2)}</pre></div>
                `;
            } catch (error) {
                results.innerHTML = `
                    <div class="error">‚ùå API Search Test Failed:</div>
                    <div><strong>Error:</strong> ${error.message}</div>
                    <div><strong>Check:</strong> CORS configuration, API endpoint availability</div>
                `;
            }
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }
    </script>
</body>
</html>
